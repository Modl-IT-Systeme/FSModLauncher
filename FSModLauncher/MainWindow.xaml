<Window x:Class="FSModLauncher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:local="clr-namespace:FSModLauncher"
        mc:Ignorable="d"
        Title="FS25 Mod Launcher" Height="700" Width="1200"
        WindowStartupLocation="CenterScreen"
        Icon="pack://application:,,,/icon.ico"
        ui:WindowHelper.UseModernWindowStyle="True">

    <Window.Resources>
        <Style x:Key="StatusBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="10,4" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <DataTemplate x:Key="StatusTemplate">
            <Border>
                <Border.Style>
                    <Style TargetType="Border" BasedOn="{StaticResource StatusBadgeStyle}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Status}" Value="Latest">
                                <Setter Property="Background" Value="{StaticResource StatusSuccessBrush}" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Status}" Value="Missing">
                                <Setter Property="Background" Value="{StaticResource StatusErrorBrush}" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Status}" Value="UpdateAvailable">
                                <Setter Property="Background" Value="{StaticResource StatusWarningBrush}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <TextBlock Text="{Binding StatusText}" Foreground="White" FontWeight="SemiBold" FontSize="12" />
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <ui:NavigationView x:Name="NavigationViewControl"
                          IsBackButtonVisible="Collapsed"
                          IsSettingsVisible="False"
                          OpenPaneLength="200"
                          CompactModeThresholdWidth="1000"
                          ExpandedModeThresholdWidth="1200"
                          SelectionChanged="NavigationView_SelectionChanged"
                          Header="{Binding StatusMessage}">
            
            <ui:NavigationView.MenuItems>
                <ui:NavigationViewItem Content="Mod Manager" Tag="ModManager">
                    <ui:NavigationViewItem.Icon>
                        <ui:FontIcon Glyph="&#xE8F1;"/>
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
                <ui:NavigationViewItem Content="Settings" Tag="Settings">
                    <ui:NavigationViewItem.Icon>
                        <ui:FontIcon Glyph="&#xE713;"/>
                    </ui:NavigationViewItem.Icon>
                </ui:NavigationViewItem>
            </ui:NavigationView.MenuItems>

            <ui:NavigationView.HeaderTemplate>
                <DataTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0"
                                   Text="{Binding}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center" />
                        
                        <!-- Update Available Button -->
                        <Button Grid.Column="1"
                                Content="{Binding DataContext.UpdateVersion, StringFormat='Update to {0}', RelativeSource={RelativeSource AncestorType=Window}}"
                                Command="{Binding DataContext.ShowUpdateDialogCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                Style="{StaticResource AccentButtonStyle}"
                                FontSize="11"
                                Padding="10,4"
                                Margin="0,0,8,0"
                                VerticalAlignment="Center">
                            <Button.Visibility>
                                <Binding Path="DataContext.UpdateAvailable" RelativeSource="{RelativeSource AncestorType=Window}">
                                    <Binding.Converter>
                                        <local:BooleanToVisibilityConverter/>
                                    </Binding.Converter>
                                </Binding>
                            </Button.Visibility>
                        </Button>
                        
                        <Border Grid.Column="2"
                                Background="{DynamicResource CardBackgroundFillColorDefault}"
                                BorderBrush="{DynamicResource ControlStrokeColorDefault}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="12,6">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Server:" 
                                           FontSize="11" 
                                           FontWeight="Medium"
                                           Margin="0,0,6,0"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding DataContext.ServerStatus, RelativeSource={RelativeSource AncestorType=Window}}" 
                                           FontSize="11" 
                                           FontWeight="SemiBold" 
                                           Foreground="{StaticResource AccentTextBrush}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </DataTemplate>
            </ui:NavigationView.HeaderTemplate>

            <Grid>
                <ContentPresenter x:Name="ContentPresenter" />
                
                <!-- Mod Manager Page (Default) -->
                <Grid x:Name="ModManagerPage" Margin="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Action Buttons -->
                    <ui:CommandBar Grid.Row="0" DefaultLabelPosition="Right" Background="Transparent">
                        <ui:AppBarButton Label="Check Mods" Icon="Refresh" Command="{Binding CheckModsCommand}" 
                                        IsEnabled="{Binding IsLoading, Converter={x:Static local:BooleanInverterConverter.Instance}}" />
                        <ui:AppBarButton Label="Download Missing/Updates" Icon="Download" Command="{Binding DownloadMissingAndUpdatesCommand}"
                                        IsEnabled="{Binding IsDownloading, Converter={x:Static local:BooleanInverterConverter.Instance}}" />
                        <ui:AppBarButton Label="Launch FS25" Icon="Play" Command="{Binding LaunchGameCommand}" />
                        
                        <ui:CommandBar.SecondaryCommands>
                            <ui:AppBarButton Label="Open Mods Folder" Icon="Folder" Command="{Binding OpenModsFolderCommand}" />
                        </ui:CommandBar.SecondaryCommands>
                    </ui:CommandBar>

                    <!-- Progress Bar -->
                    <ProgressBar Grid.Row="1"
                                Height="4"
                                Margin="0,8,0,8"
                                Value="{Binding OverallProgress}"
                                Maximum="100"
                                Visibility="{Binding IsDownloading, Converter={x:Static local:BooleanToVisibilityConverter.Instance}}" />

                    <!-- Mod List -->
                    <DataGrid Grid.Row="2"
                         ItemsSource="{Binding Mods}"
                         AutoGenerateColumns="False"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         CanUserResizeColumns="True"
                         IsReadOnly="True"
                         SelectionMode="Single"
                         SelectionUnit="FullRow"
                         CanUserSortColumns="False">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="200" />
                        <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="*" />
                        <DataGridTextColumn Header="Server Version" Binding="{Binding ServerVersion}" Width="120" />
                        <DataGridTextColumn Header="Local Version" Binding="{Binding LocalVersion}" Width="120" />
                        <DataGridTemplateColumn Header="Status" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ContentPresenter Content="{Binding}" ContentTemplate="{StaticResource StatusTemplate}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Progress" Width="200">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid Visibility="{Binding IsDownloading, Converter={x:Static local:BooleanToVisibilityConverter.Instance}}">
                                        <Grid.RowDefinitions>
                                            <RowDefinition />
                                            <RowDefinition />
                                        </Grid.RowDefinitions>
                                        <ProgressBar Grid.Row="0"
                                                    Height="16"
                                                    Value="{Binding DownloadProgress}"
                                                    Maximum="100" />
                                        <TextBlock Grid.Row="1"
                                                  Text="{Binding DownloadStatus}"
                                                  FontSize="10"
                                                  HorizontalAlignment="Center" />
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Action" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Download"
                                            Command="{Binding DownloadCommand}"
                                            Visibility="{Binding ShowDownloadButton, Converter={x:Static local:BooleanToVisibilityConverter.Instance}}"
                                            IsEnabled="{Binding CanDownload}"
                                            Padding="8,4"
                                            FontSize="11" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
                </Grid>
            </Grid>
        </ui:NavigationView>

        <!-- Status indicator overlay -->
        <Grid VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="20"
              Visibility="{Binding IsLoading, Converter={x:Static local:BooleanToVisibilityConverter.Instance}}">
            <Border Background="{DynamicResource AcrylicBackgroundFillColorDefault}"
                    BorderBrush="{DynamicResource ControlStrokeColorDefault}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16,12">
                <StackPanel Orientation="Horizontal">
                    <ui:ProgressRing Width="20" Height="20" IsActive="True" Margin="0,0,8,0" />
                    <TextBlock Text="Loading..." VerticalAlignment="Center" />
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>